<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Web Terminal</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css"
    />
    <style>
      html,
      body {
        height: 100vh;
        width: 100vw;
        margin: 0;
        padding: 0;
        background: #000;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #terminal {
        height: 100%;
        width: 100%;
        margin: 0;
        pad: 0;
        max-width: 1300px;
        max-height: 700px;
      }
    </style>
  </head>
  <body>
    <div id="terminal"></div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script>
      const term = new Terminal({
        fontFamily: "monospace",
        rendererType: "canvas",
      });

      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);
      term.open(document.getElementById("terminal"));
      fitAddon.fit();

      const cols = term.cols;
      const rows = term.rows;
      term.resize(cols + 1, rows);
      console.log(term.rows, term.cols);

      const protocol = location.protocol === "https:" ? "wss" : "ws";
      const socket = new WebSocket(`${protocol}://${location.host}/client`);

      socket.binaryType = "arraybuffer";

      term.onData((data) => {
        const encoder = new TextEncoder();
        const encoded = encoder.encode(data);
        socket.send(encoded);
      });

      socket.onmessage = function (event) {
        const data = new Uint8Array(event.data);
        term.write(data);
      };

      socket.onopen = () => {
        const dimensions = `${rows} ${cols}`;
        socket.send(dimensions);
        term.write("Connected to PTY\r\n");
      };
      socket.onclose = () => term.write("\r\n[Connection closed]");
    </script>
  </body>
</html>
